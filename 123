import com.fasterxml.jackson.databind.ObjectMapper;
import org.apache.http.HttpResponse;
import org.apache.http.StatusLine;
import org.apache.http.client.ClientProtocolException;
import org.apache.http.client.HttpClient;
import org.apache.http.client.ResponseHandler;
import org.apache.http.client.methods.HttpGet;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.MockedStatic;
import org.springframework.core.env.Environment;

import static org.mockito.Mockito.*;
import static org.junit.jupiter.api.Assertions.*;

class CIFApiClientTest {

    private CIFApiClient cifApiClient;
    private QuoteRequestHeaders reqHeaders;

    @BeforeEach
    void setUp() {
        cifApiClient = new CIFApiClient();
        cifApiClient.cifUrl = "http://dummy.url/@@CIF NUMBER@@";
        cifApiClient.CIF_ENV_ID_KEY = "ENV_ID";
        cifApiClient.CIF_ENG_SYS_KEY = "ENV_SYS";

        reqHeaders = mock(QuoteRequestHeaders.class);
    }

    @Test
    void testGetIINumber_LowerEnv_Normal() throws Exception {
        // Setup environment for LOWER_ENV
        Environment env = mock(Environment.class);
        cifApiClient.environment = env;
        when(env.acceptsProfiles("lower-env")).thenReturn(true);
        when(env.acceptsProfiles("upper-env")).thenReturn(false);
        when(reqHeaders.getHeaderValue(anyString())).thenReturn("headerId");

        // Mock OAuthClient and HttpClient
        HttpClient mockHttpClient = mock(HttpClient.class);
        try (MockedStatic<OAuthClient> mocked = mockStatic(OAuthClient.class)) {
            OAuthClient mockOAuthClient = mock(OAuthClient.class);
            mocked.when(OAuthClient::getInstance).thenReturn(mockOAuthClient);

            when(mockOAuthClient.getSyncClient()).thenReturn(mockHttpClient);
            doNothing().when(mockOAuthClient).addOAuthTokenWithSecondaryToken(any(HttpGet.class), anyString());

            // Mock HTTP execute to return valid JSON
            when(mockHttpClient.execute(any(HttpGet.class), any(ResponseHandler.class)))
                    .thenAnswer(invocation -> {
                        ResponseHandler<String> handler = invocation.getArgument(1);
                        // Return JSON with alternateKey
                        return "{\"partyToAlternatePartyKey\":[{\"alternateKey\":\"123\"}]}";
                    });

            String iiNumber = cifApiClient.getIINumber(reqHeaders, "12345", "jwt");
            assertEquals("123", iiNumber); // covers happy path
        }
    }

    @Test
    void testGetIINumber_LowerEnv_HeaderEmpty() throws Exception {
        Environment env = mock(Environment.class);
        cifApiClient.environment = env;
        when(env.acceptsProfiles("lower-env")).thenReturn(true);
        when(env.acceptsProfiles("upper-env")).thenReturn(false);
        when(reqHeaders.getHeaderValue(anyString())).thenReturn(null); // simulate blank header

        HttpClient mockHttpClient = mock(HttpClient.class);
        try (MockedStatic<OAuthClient> mocked = mockStatic(OAuthClient.class)) {
            OAuthClient mockOAuthClient = mock(OAuthClient.class);
            mocked.when(OAuthClient::getInstance).thenReturn(mockOAuthClient);

            when(mockOAuthClient.getSyncClient()).thenReturn(mockHttpClient);
            doNothing().when(mockOAuthClient).addOAuthTokenWithSecondaryToken(any(HttpGet.class), anyString());

            // Throw generic exception to hit catch block
            when(mockHttpClient.execute(any(HttpGet.class), any(ResponseHandler.class)))
                    .thenThrow(new RuntimeException("unexpected error"));

            String iiNumber = cifApiClient.getIINumber(reqHeaders, "12345", "jwt");
            assertEquals(Constants.DEFAULT_II_NUMBER, iiNumber); // fallback executed
        }
    }

    @Test
    void testGetIINumber_UpperEnv_Normal() throws Exception {
        Environment env = mock(Environment.class);
        cifApiClient.environment = env;
        when(env.acceptsProfiles("lower-env")).thenReturn(false);
        when(env.acceptsProfiles("upper-env")).thenReturn(true);

        HttpClient mockHttpClient = mock(HttpClient.class);
        try (MockedStatic<OAuthClient> mocked = mockStatic(OAuthClient.class)) {
            OAuthClient mockOAuthClient = mock(OAuthClient.class);
            mocked.when(OAuthClient::getInstance).thenReturn(mockOAuthClient);

            when(mockOAuthClient.getSyncClient()).thenReturn(mockHttpClient);
            doNothing().when(mockOAuthClient).addOAuthTokenWithSecondaryToken(any(HttpGet.class), anyString());

            // Throw ClientProtocolException to hit its catch block
            when(mockHttpClient.execute(any(HttpGet.class), any(ResponseHandler.class)))
                    .thenThrow(new ClientProtocolException("404"));

            String iiNumber = cifApiClient.getIINumber(reqHeaders, "12345", "jwt");
            assertEquals(Constants.DEFAULT_II_NUMBER, iiNumber);
        }
    }

    @Test
    void testGetIINumber_UpperEnv_HeaderBlankAndException() throws Exception {
        Environment env = mock(Environment.class);
        cifApiClient.environment = env;
        when(env.acceptsProfiles("lower-env")).thenReturn(false);
        when(env.acceptsProfiles("upper-env")).thenReturn(true);

        when(reqHeaders.getHeaderValue(anyString())).thenReturn(null);

        HttpClient mockHttpClient = mock(HttpClient.class);
        try (MockedStatic<OAuthClient> mocked = mockStatic(OAuthClient.class)) {
            OAuthClient mockOAuthClient = mock(OAuthClient.class);
            mocked.when(OAuthClient::getInstance).thenReturn(mockOAuthClient);

            when(mockOAuthClient.getSyncClient()).thenReturn(mockHttpClient);
            doNothing().when(mockOAuthClient).addOAuthTokenWithSecondaryToken(any(HttpGet.class), anyString());

            // Simulate RuntimeException to hit generic catch block
            when(mockHttpClient.execute(any(HttpGet.class), any(ResponseHandler.class)))
                    .thenThrow(new RuntimeException("unexpected error"));

            String iiNumber = cifApiClient.getIINumber(reqHeaders, "12345", "jwt");
            assertEquals(Constants.DEFAULT_II_NUMBER, iiNumber);
        }
    }
}