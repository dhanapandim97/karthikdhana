import com.fasterxml.jackson.core.JsonParser;
import com.fasterxml.jackson.databind.*;
import com.fasterxml.jackson.databind.deser.ContextualDeserializer;
import com.fasterxml.jackson.databind.deser.std.StdDeserializer;
import com.fasterxml.jackson.databind.node.JsonNodeType;

import java.io.IOException;

public class GenericDelegatingDeserializer<T>
        extends StdDeserializer<T>
        implements ContextualDeserializer {

    private final JsonDeserializer<Object> delegate;
    private final JavaType type;

    public GenericDelegatingDeserializer(JavaType type) {
        super(type);
        this.type = type;
        this.delegate = null;
    }

    private GenericDelegatingDeserializer(JavaType type, JsonDeserializer<?> delegate) {
        super(type);
        this.type = type;
        this.delegate = (JsonDeserializer<Object>) delegate;
    }

    @Override
    @SuppressWarnings("unchecked")
    public T deserialize(JsonParser p, DeserializationContext ctxt) throws IOException {
        // peek as tree without losing parser
        JsonNode node = p.readValueAsTree();

        if (node == null) {
            return (T) ctxt.findRootValueDeserializer(type).getEmptyValue(ctxt);
        }

        // Case 1: plain text <Pojo>*</Pojo>
        if (node.getNodeType() == JsonNodeType.STRING || node.isTextual()) {
            String text = node.asText();
            if ("*".equals(text)) {
                // ignore → empty POJO
                return (T) ctxt.findRootValueDeserializer(type).getEmptyValue(ctxt);
            }
        }

        // Case 2: structured XML → reparse with delegate
        if (delegate != null) {
            // Convert node back to parser for delegate
            JsonParser nodeParser = node.traverse(p.getCodec());
            nodeParser.nextToken();
            return (T) delegate.deserialize(nodeParser, ctxt);
        }

        return (T) ctxt.findRootValueDeserializer(type).getEmptyValue(ctxt);
    }

    @Override
    public JsonDeserializer<?> createContextual(DeserializationContext ctxt, BeanProperty property)
            throws JsonMappingException {
        JsonDeserializer<Object> deser = ctxt.findNonContextualValueDeserializer(type);
        return new GenericDelegatingDeserializer<>(type, deser);
    }
}